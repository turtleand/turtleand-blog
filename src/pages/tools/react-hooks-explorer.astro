---
import Layout from "@layouts/Layout.astro";
import Header from "@components/Header.astro";
import Footer from "@components/Footer.astro";

// Import all hook demos
import UseStateDemo from "@components/tools/hooks/UseStateDemo";
import UseRefDemo from "@components/tools/hooks/UseRefDemo";
import UseCallbackDemo from "@components/tools/hooks/UseCallbackDemo";
import UseMemoDemo from "@components/tools/hooks/UseMemoDemo";
import UseEffectDemo from "@components/tools/hooks/UseEffectDemo";
---

<Layout
  title="React Hooks Explorer"
  description="Interactive explorer for common React hooks"
>
  <Header activeNav="tools" />
  <main id="main-content">
    <div class="mx-auto max-w-4xl p-4 sm:p-6">
      <div
        class="mb-6 rounded-lg bg-gradient-to-r from-blue-600 to-purple-600 shadow-lg"
      >
        <div class="p-6 sm:p-8">
          <h1 class="mb-3 text-2xl font-bold text-white sm:text-3xl">
            React Hooks Explorer
          </h1>
          <p class="text-white/90">
            An interactive guide to React hooks and patterns used in
            visualization components
          </p>
        </div>
      </div>

      <!-- Navigation Tabs -->
      <div
        class="sticky top-4 z-10 mb-8 flex flex-wrap gap-2 rounded-lg bg-white p-3 shadow-md"
        id="hook-nav"
      >
        <button
          class="tab-btn active rounded bg-blue-500 px-4 py-2 text-white transition-colors"
          data-hook="state">useState</button
        >
        <button
          class="tab-btn rounded border border-purple-500 px-4 py-2 text-purple-700 transition-colors hover:bg-purple-50"
          data-hook="refs">useRef</button
        >
        <button
          class="tab-btn rounded border border-green-500 px-4 py-2 text-green-700 transition-colors hover:bg-green-50"
          data-hook="callback">useCallback</button
        >
        <button
          class="tab-btn rounded border border-amber-500 px-4 py-2 text-amber-700 transition-colors hover:bg-amber-50"
          data-hook="memo">useMemo</button
        >
        <button
          class="tab-btn rounded border border-indigo-500 px-4 py-2 text-indigo-700 transition-colors hover:bg-indigo-50"
          data-hook="effect">useEffect</button
        >
      </div>

      <!-- Hook Component Containers -->
      <div id="state-container" class="hook-container">
        <UseStateDemo client:visible />
      </div>
      <div id="refs-container" class="hook-container hidden">
        <UseRefDemo client:visible />
      </div>
      <div id="callback-container" class="hook-container hidden">
        <UseCallbackDemo client:visible />
      </div>
      <div id="memo-container" class="hook-container hidden">
        <UseMemoDemo client:visible />
      </div>
      <div id="effect-container" class="hook-container hidden">
        <UseEffectDemo client:visible />
      </div>

      <!-- Footer info -->
      <div class="mb-4 mt-8 text-center text-sm text-gray-500">
        This explorer demonstrates React hooks and patterns used in
        visualization components.
        <br />
        Open your browser console to see additional logs from the various effects.
      </div>
    </div>
  </main>
  <Footer />
</Layout>

<script>
  // Add TypeScript declaration for window property
  declare global {
    interface Window {
      initializeHooksTabs: () => void;
    }
  }

  // Create a function that can be attached to the window for access across navigation
  window.initializeHooksTabs = function () {
    // Only initialize if not already initialized
    const hookNav = document.getElementById("hook-nav");
    if (hookNav?.getAttribute("data-initialized") === "true") return;

    const tabButtons = document.querySelectorAll(".tab-btn");
    const hookContainers = document.querySelectorAll(".hook-container");

    // Skip if elements aren't available yet
    if (tabButtons.length === 0 || hookContainers.length === 0) return;

    // Mark as initialized
    hookNav?.setAttribute("data-initialized", "true");

    // Initialize scroll position storage
    const scrollPositions = new Map();

    // Define valid hook types
    type HookType = "state" | "refs" | "callback" | "memo" | "effect";

    // Function to set the active tab
    function setActiveTab(selectedHook: HookType) {
      // Update all button styles - using direct DOM references for reliability
      const allButtons = document.querySelectorAll(".tab-btn");

      allButtons.forEach(btn => {
        const hook = btn.getAttribute("data-hook");

        if (hook === selectedHook) {
          // Active button
          btn.classList.add("active");
          btn.classList.remove("border");

          // Set color based on hook type
          if (hook === "state")
            btn.className = `tab-btn active transition-colors px-4 py-2 rounded bg-blue-500 text-white`;
          if (hook === "refs")
            btn.className = `tab-btn active transition-colors px-4 py-2 rounded bg-purple-500 text-white`;
          if (hook === "callback")
            btn.className = `tab-btn active transition-colors px-4 py-2 rounded bg-green-500 text-white`;
          if (hook === "memo")
            btn.className = `tab-btn active transition-colors px-4 py-2 rounded bg-amber-500 text-white`;
          if (hook === "effect")
            btn.className = `tab-btn active transition-colors px-4 py-2 rounded bg-indigo-500 text-white`;
        } else {
          // Inactive button
          btn.classList.remove("active");
          btn.classList.add("border");

          // Set color based on hook type
          if (hook === "state")
            btn.className = `tab-btn transition-colors px-4 py-2 rounded border border-blue-500 text-blue-700 hover:bg-blue-50`;
          if (hook === "refs")
            btn.className = `tab-btn transition-colors px-4 py-2 rounded border border-purple-500 text-purple-700 hover:bg-purple-50`;
          if (hook === "callback")
            btn.className = `tab-btn transition-colors px-4 py-2 rounded border border-green-500 text-green-700 hover:bg-green-50`;
          if (hook === "memo")
            btn.className = `tab-btn transition-colors px-4 py-2 rounded border border-amber-500 text-amber-700 hover:bg-amber-50`;
          if (hook === "effect")
            btn.className = `tab-btn transition-colors px-4 py-2 rounded border border-indigo-500 text-indigo-700 hover:bg-indigo-50`;
        }
      });

      // Show the selected hook's container, hide others
      document.querySelectorAll(".hook-container").forEach(container => {
        if (container.id === `${selectedHook}-container`) {
          container.classList.remove("hidden");
        } else {
          container.classList.add("hidden");
        }
      });
    }

    // A simpler approach - using addEventListener instead of onclick property
    tabButtons.forEach(button => {
      // First remove any existing click listeners
      const newButton = button.cloneNode(true) as HTMLButtonElement;
      button.parentNode?.replaceChild(newButton, button);

      // Add event listener to the fresh button
      newButton.addEventListener("click", function (e) {
        e.preventDefault();

        // Store current scroll position
        const activeHook = document
          .querySelector(".tab-btn.active")
          ?.getAttribute("data-hook");
        if (activeHook) {
          scrollPositions.set(activeHook, window.scrollY);
        }

        const selectedHook = this.getAttribute("data-hook") as HookType;
        setActiveTab(selectedHook);

        // Restore scroll position or scroll to top
        if (scrollPositions.has(selectedHook)) {
          setTimeout(() => {
            window.scrollTo({ top: scrollPositions.get(selectedHook) });
          }, 0);
        } else {
          // Scroll to the top of the container with a small offset for the sticky header
          const container = document.getElementById(
            `${selectedHook}-container`
          );
          if (container) {
            const headerOffset =
              document.getElementById("hook-nav")?.offsetHeight || 0;
            const containerTop =
              container.getBoundingClientRect().top +
              window.pageYOffset -
              headerOffset -
              20;
            window.scrollTo({ top: containerTop, behavior: "smooth" });
          }
        }
      });
    });

    // Set initial active tab - always use "state" as default
    const defaultTab = "state" as HookType;
    setActiveTab(defaultTab);

    console.log("React Hooks Explorer initialized");
  };

  // Initialize immediately
  window.initializeHooksTabs();

  // Handle page visibility changes (when returning to the tab)
  document.addEventListener("visibilitychange", () => {
    if (document.visibilityState === "visible") {
      // Reset initialization flag and reinitialize
      const hookNav = document.getElementById("hook-nav");
      hookNav?.removeAttribute("data-initialized");
      window.initializeHooksTabs();
    }
  });

  // Also handle navigation events via a short delay
  document.addEventListener("astro:after-swap", () => {
    // Short delay to ensure DOM is fully updated
    setTimeout(() => {
      // Reset initialization flag and reinitialize
      const hookNav = document.getElementById("hook-nav");
      if (hookNav) {
        hookNav.removeAttribute("data-initialized");
        window.initializeHooksTabs();
      }
    }, 50);
  });

  // Fallback for non-Astro navigation
  document.addEventListener("DOMContentLoaded", window.initializeHooksTabs);
  window.addEventListener("load", window.initializeHooksTabs);

  // Add periodic check inside the main script instead of inline script
  // Using IIFE to avoid global variable conflicts
  (function () {
    // Create unique interval ID for this instance
    const intervalId = setInterval(() => {
      const hookNav = document.getElementById("hook-nav");
      if (hookNav && window.initializeHooksTabs) {
        window.initializeHooksTabs();
      }
      // Clear after 10 attempts (2 seconds)
      if (!hookNav || Date.now() - loadTime > 2000) {
        clearInterval(intervalId);
      }
    }, 200);

    // Record when this instance started
    const loadTime = Date.now();
  })();
</script>

<style>
  .tab-btn.active {
    font-weight: 500;
  }
</style>
